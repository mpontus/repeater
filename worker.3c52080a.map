{"version":3,"sources":["RoundRobin.ts","VoiceDetector.ts","worker.ts"],"names":[],"mappings":"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","file":"worker.3c52080a.map","sourceRoot":"..","sourcesContent":["export interface IRoundRobin {\n  write(data: Float32Array): void;\n\n  readLast(length: number): Float32Array;\n}\n\nexport class RoundRobin implements IRoundRobin {\n  private readonly buffer: Float32Array;\n  private offset: number = 0;\n\n  constructor(size: number) {\n    this.buffer = new Float32Array(size);\n    this.offset = 0;\n  }\n\n  write(data: Float32Array) {\n    if (this.offset + data.length > this.buffer.length) {\n      this.buffer.set(\n        data.subarray(0, this.buffer.length - this.offset),\n        this.offset\n      );\n      this.buffer.set(data.subarray(this.buffer.length - this.offset));\n      this.offset = this.buffer.length - this.offset;\n    } else {\n      this.buffer.set(data, this.offset);\n      this.offset += data.length;\n    }\n  }\n\n  readLast(length: number): Float32Array {\n    length = Math.min(this.buffer.length, length);\n\n    if (length <= this.offset) {\n      return this.buffer.slice(this.offset - length, this.offset);\n    }\n\n    const output = new Float32Array(length);\n\n    output.set(\n      this.buffer.subarray(this.buffer.length - (length - this.offset))\n    );\n    output.set(this.buffer.subarray(0, this.offset), length - this.offset);\n\n    return output;\n  }\n}\n\nexport default RoundRobin;\n","export interface IVoiceDetector {\n  write(data: Float32Array): void;\n\n  isHearingVoice(): boolean;\n}\n\nexport class AverageAmplitudeVoiceDetector implements IVoiceDetector {\n  private readonly sampleCount: number;\n  private readonly threshold: number;\n\n  private avg: number = 0;\n\n  constructor(threshold: number, sampleCount: number) {\n    this.sampleCount = sampleCount;\n    this.threshold = threshold;\n  }\n\n  write(data: Float32Array) {\n    const sum = data.map(Math.abs).reduce((a, b) => a + b);\n\n    this.avg *= 1 - data.length / this.sampleCount;\n    this.avg += sum / this.sampleCount;\n  }\n\n  isHearingVoice() {\n    return this.avg > this.threshold;\n  }\n}\n\nexport default AverageAmplitudeVoiceDetector;\n","import RoundRobin from \"./RoundRobin\";\nimport VoiceDetector from \"./VoiceDetector\";\n\nconst AMPLITUDE_THRESHOLD = 0.02;\nconst SAMPLE_RATE = 44100;\nconst MAX_DURATION = 60;\nconst SILENCE_DURATION = 0.5;\n\nconst ctx: Worker = self as any;\nconst buffer = new RoundRobin(MAX_DURATION * SAMPLE_RATE);\nconst voiceDetector = new VoiceDetector(\n  AMPLITUDE_THRESHOLD,\n  SILENCE_DURATION * SAMPLE_RATE\n);\n\nlet recording = false;\nlet recordingSize = 0;\n\nctx.onmessage = e => {\n  const pcm: Float32Array = e.data;\n\n  voiceDetector.write(pcm);\n  buffer.write(pcm);\n\n  const isHearingVoice = voiceDetector.isHearingVoice();\n\n  if (!recording && isHearingVoice) {\n    recording = true;\n    recordingSize = 0;\n\n    ctx.postMessage({ type: \"voice_start\" });\n  } else if (recording) {\n    recordingSize += pcm.length;\n  }\n\n  if (recording && !isHearingVoice) {\n    const audio = buffer.readLast(\n      recordingSize + SILENCE_DURATION * SAMPLE_RATE\n    );\n\n    ctx.postMessage({\n      type: \"voice_end\",\n      payload: audio\n    });\n\n    recording = false;\n  }\n};\n"]}